<template name="newAdminCertificates">
{{#let txt="admin.certificates.newAdminCertificates"}}
  <h1>
    <ul class="admin-breadcrumbs">
      <li>{{#linkTo route="newAdminRoot"}}{{_ "admin.title"}}{{/linkTo}}</li>
      <li>{{_ "admin.certificates.name"}}</li>
    </ul>
  </h1>

  {{#if hasSuccess}}
    {{#focusingSuccessBox}}
      {{message}}
    {{/focusingSuccessBox}}
  {{/if}}
  {{#if hasError}}
    {{#focusingErrorBox}}
      {{message}}
    {{/focusingErrorBox}}
  {{/if}}

  <div class="admin-certificates">

  <p>This page allows you to configure Sandstorm's HTTPS/TLS support.</p>

  {{#if https}}
    <p>&#x2705; Your Sandstorm Server is using TLS.</p>

    <table>
      <tr>
        <th>Current Certificate Expires At:</th>
        <td>{{expires}}</td>
      </tr>
      {{#with acmeAccount}}
      <tr>
        <th>Will Attempt Renewal At:</th>
        {{#if currentlyRenewing}}
          <td>Renewing now; please wait.</td>
        {{else}}
          <td>{{renewAt}} <button class="fetch-cert-now button-primary">Renew Now</button></td>
        {{/if}}
      </tr>
      {{/with}}
    </table>
    {{#if acmeAccount}}
		{{else}}
    <p>&#x26a0; Your certificate will not be renewed automatically.</p>
    {{/if}}
  {{else}}
    <p>&#x26a0; Your Sandstorm Server is not currently using TLS.</p>
  {{/if}}

  <h2>
    <input type="radio" id="use-cert-acme" name="cert-method" />
    <label for="use-cert-acme">Manage certificates with ACME/Let's Encrypt</label>
  </h2>

  {{#with acmeAccount}}
    <h3>ACME Account Details</h3>
    <table>
      <tr><th>Directory URL:</th><td>{{directory}}</td></tr>
      <tr><th>Contact e-mail:</th><td>{{email}}</td></tr>
      <tr><td></td><td><button class="forget-acme-account button-danger">Forget ACME account</button></td></tr>
    </table>
  {{else}}
    <p>No ACME account configured. <button class="create-account button-primary">Create Account</button></p>
  {{/with}}

	<h3>DNS Provider</h3>
  {{#with acmeChallenge}}
		{{providerName}}
		{{#unless isSandcats}}
			<button class="forget-dns button-danger">Forget DNS provider</button>
		{{/unless}}
  {{else}}
    <p>No DNS provider configured. Sandstorm needs access to your DNS provider in order to pass
    ACME DNS-01 challenges, which is required to issue wildcard certificates, which
    Sandstorm requires. <button class="configure-dns button-primary">Configure DNS</button></p>
  {{/with}}

  <h2>
    <input type="radio" id="use-cert-manual" name="cert-method" />
    <label for="use-cert-manual">Manually upload a certificate</label>
  </h2>

  <form class="manual-upload">
    <table>
      <tr>
        <th><label for="key">Private key PEM:</label></th>
        <td><input type="file" name="key"></td>
      </tr>
      <tr>
        <th><label for="cert">Certificate chain PEM:</label></th>
        <td><input type="file" name="cert"></td>
      </tr>
      <tr>
        <td></td>
        <td><button class="button-primary" type="submit">Upload</button></td>
      </tr>
    </table>
  </form>

  {{#with modal}}
    {{#modalDialogWithBackdrop onDismiss=onDismiss}}
      {{#with createAccount}}
        {{#if queryTos}}
          {{#if tosUrl}}
            <p>Do you accept the certificate provider's <a href="{{tosUrl}}" target="_blank">Terms of Service</a>?</p>
          {{else}}
            <p>Do you accept the certificate provider's Terms of Service?</p>
          {{/if}}
          <p><button disabled={{loading}} class="agree-acme-tos button-primary">I agree</button></p>
        {{else}}
          <form class="create-account">
            <table>
              <tr>
                <td>ACME Service:</td>
                <td>
                  <input disabled={{loading}} type="text" name="directory" value="https://acme-v02.api.letsencrypt.org/directory"><br>
                  (Leave unchanged for Let's Encrypt.)
                </td>
              </tr>
              <tr>
                <td>Your e-mail:</td>
                <td><input disabled={{loading}} type="email" name="email"></td>
              </tr>
              <tr>
                <td></td>
                <td><button disabled={{loading}} class="button-primary" type="submit">Next</button></td>
              </tr>
            </table>
          </form>
        {{/if}}
      {{/with}}

      {{#with chooseDns}}
        <form class="choose-dns">
          <table>
            <tr>
              <td>Provider:</td>
              <td>
                <select class="choose-module" name="module">
                  {{#each dnsOptions}}
                    <option value="{{module}}">{{title}}</option>
                  {{/each}}
                </select>
              </td>
            </tr>
            <tr>
              <td>Options JSON:</td>
              <td>
                <p>Please enter the necessary configuration for this module in JSON format. See
                  <a href="https://www.npmjs.com/package/acme-dns-01-{{selectedModule}}"
                    target="_blank">the README for acme-dns-01-{{selectedModule}}</a>
                  for information about the options format.</p>
                <textarea placeholder="{ ... }" name="options"></textarea>
              </td>
            </tr>
            <tr>
              <td></td>
              <td><button disabled={{loading}} class="button-primary" type="submit">OK</button></td>
            </tr>
          </table>
        </form>
      {{/with}}
    {{/modalDialogWithBackdrop}}
  {{/with}}
  </div>
{{/let}}
</template>
